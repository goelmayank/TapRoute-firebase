<!DOCTYPE html>
<html>
<head>
	<title>Transmitter</title>
	<link rel="stylesheet" href="../assets/css/basic.css" type="text/css">
	<script src="../lib/sonicnet.js"></script>
</head>
<body>
	<h1>Transmitter</h1>
	<div class="row">
		<label>Select pin</label><br>
		<select single id="get_pin">
			<option>2345</option>
			<option>2354</option>
			<option>3254</option>
			<option>8524</option>
			<option>4258</option>
		</select>
	</div>
	<div class="row">
		<div id="button">Send PIN</div>
		<div>
			Money Left: 
			<div id="wallet">1000</div>
		</div>
	</div>
	<div class="row">
		<ul id="details">

		</ul>
	</div>
	<script>
		var mon = 1000;
		wallet.innerText = mon;
		var audioContext = new window.AudioContext() || new webkitAudioContext();
		var ALPHABET = '0123456789@A';
		
		var socketOptions = { alphabet: ALPHABET,  charDuration: .2 };
		
		var ans = ""; //prompt('answer "y" for audible range');
		if(ans == 'y'){
			socketOptions.freqMin = 10500; socketOptions.freqMax= 15000;
			
		}
		var wallets = {};

		var running = false;
		var pin = ("0000" + createPin()).slice(-4);
		var transmit_timer;
		function startInterval(){
			transmit_timer = setInterval(function(){
				pin = getPin();	
				transmit(pin);
				console.log('sending pin', new Date().getTime());
			}, 3000);
		}
		function getPin(){
			console.log(get_pin.value);
			return get_pin.value
		}
		function stopInterval(){
			clearInterval(transmit_timer);
		}

		button.addEventListener('click', ()=>{
			
			if(running){
				button.innerText = "Send PIN"
				stopInterval();
				running = false;
				return;
			}
			
			
			button.innerText = "Sending PIN"
			pin = getPin();
			console.log('sending pin', new Date().getTime());	
			transmit(pin);
			startInterval();
			running = true;
			

		});
		
		function transmit(string) {
			console.log(string)
			if((wallets[string]) == undefined ||(wallets[string]) == NaN){
				console.log('set wallet')
				wallets[string] = 1000;
			}
			wallet.innerText = wallets[string];
			var d = document.createElement('li');

			d.innerText = "sending message ";
			details.appendChild(d);
			ssocket = new SonicSocket(socketOptions);

			ssocket.send(string);
		}

		function createPin(){

			// return Math.floor(Math.random()*9999);
			// var array = ['0', '1','2', '3', '4', '5', '6', '7', '8', '9'];
			return '2345';
		}
		// var sserver;
		
		sserver = new SonicServer({alphabet: ALPHABET});

		sserver.on('message', function(message) {
			console.log('sserver ', message);
			if(message.charAt(0) == "@"){
				console.log('reciving @fare ', message , new Date().getTime());
				var money = parseInt(message.substring(1));
				if(money == NaN || money == undefined)money = 0;
				var money_left = parseInt(wallet.innerText) - money;
				wallets[get_pin.value] = money_left;
				wallet.innerText = money_left;
				button.innerText = "Send PIN"
				stopInterval();
				running = false;
				return;
			}
		});

		sserver.start();
		function debugMode(){
			sserver.setDebug(true);
			// sserver.debugDraw_();
		}	
		// setTimeout(debugMode, 2000);
		
	</script>
</body>
</html>