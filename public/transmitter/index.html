<!DOCTYPE html>
<html>
<head>
	<title>Transmitter</title>
	<script src="../../lib/sonicnet.js"></script>
</head>
<body>
	<h1>Transmitter</h1>
	<div class="row">
		<div id="button">Send PIN</div>
		<div id="wallet">1000</div>
	</div>
	<div class="row">
		<ul id="details">

		</ul>
	</div>
	<script>
		var mon = 1000;
		wallet.innerText = mon;
		var audioContext = new window.AudioContext() || new webkitAudioContext();
		var ALPHABET = '0123456789';
		var socketOptions = {alphabet: ALPHABET, charDuration: .2, freqMin: 20500, freqMax: 21500 };
		
		var ans = ""; //prompt('answer "y" for audible range');
		if(ans == 'y'){
			socketOptions.freqMin = 10500; socketOptions.freqMax= 15000;
			
		}

		var running = false;
		var pin = ("0000" + createPin()).slice(-4);
		var transmit_timer;
		function startInterval(){
			transmit_timer = setInterval(function(){			
				transmit(pin);
			}, 3000);
		}
		function stopInterval(){
			clearInterval(transmit_timer);
		}

		button.addEventListener('click', ()=>{
			
			if(running){
				button.innerText = "Send PIN"
				stopInterval();
				running = false;
				return;
			}
			
			button.innerText = "Sending PIN"
			startInterval();
			running = true;
			reciveResponse();

		});
		function transmit(string) {
		  console.log(string)
		  var d = document.createElement('li');

		  d.innerText = "sending message ";
		  details.appendChild(d);
		  ssocket = new SonicSocket(socketOptions);

		  ssocket.send(string);
		}

		function createPin(){
			return Math.floor(Math.random()*9999);
		}
		function reciveResponse(){
			var sserver = new SonicServer({alphabet:'_', freqMin: 21900, freqMax: 22000});
			sserver.on('message', function(message) {
				console.log(message);
				if(message == "_"){
					button.innerText = "Send PIN"
					stopInterval();
					running = false;
					return;
				}
			});
			sserver.start();	
		}
	</script>
</body>
</html>