<!DOCTYPE html>
<html>
<head>
	<title>Transmitter</title>
	<link rel="stylesheet" href="../assets/css/basic.css" type="text/css">
	<script src="../lib/sonicnet.js"></script>
</head>
<body>
	<section class="wrapper">
	<h1>Transmitter</h1>
	<div class="row">
		<label>Select pin</label><br>
		<select single id="get_pin">
			<option>2345</option>
			<option>2354</option>
			<option>3254</option>
			<option>8524</option>
			<option>4258</option>
		</select>
	</div>
	<div class="row">
		<div id="button">Send PIN</div>
		<div>
			Money Left: 
			<div id="wallet">1000</div>
		</div>
	</div>
	<div class="row">
		<ul id="details">

		</ul>
	</div>
	
	</section>
	<!-- <section class="logger">
		<div class="row">
			<div id="log_info">
				
			</div>
		</div>
	</section> -->
	<script>
		var mon = 1000;
		var info = "";

		wallet.innerText = mon;
		var audioContext = new window.AudioContext() || new webkitAudioContext();
		var ALPHABET = '0123456789@A';
		var socketOptions = { alphabet: ALPHABET,  charDuration: .2 };
		
		var ans = ""; //prompt('answer "y" for audible range');
		if(ans == 'y'){
			socketOptions.freqMin = 10500; socketOptions.freqMax= 15000;
			
		}
		var wallets = {};

		var running = false;
		var pin = ("0000" + createPin()).slice(-4);
		var transmit_timer;
		function startInterval(){
			transmit_timer = setInterval(function(){
				pin = getPin();	
				transmit(pin);
			}, 2000);
		}
		function getPin(){
			console.log('pin value: ' + get_pin.value);
			return get_pin.value
		}
		function stopInterval(){
			clearInterval(transmit_timer);
		}

		button.addEventListener('click', ()=>{
			
			if(running){
				button.innerText = "Send PIN"
				stopInterval();
				running = false;
				return;
			}
			
			
			button.innerText = "Sending PIN"
			pin = getPin();	
			transmit(pin);
			startInterval();
			running = true;
			

		});
		
		function transmit(string) {
			
			if((wallets[string]) == undefined ||(wallets[string]) == NaN){
				console.log('set wallet');
				wallets[string] = 1000;
			}
			wallet.innerText = wallets[string];
			var d = document.createElement('li');

			d.innerText = "sending message @" + (new Date()).toString().split(" ")[4];
			details.appendChild(d);
			ssocket = new SonicSocket(socketOptions);
			console.log('sending string: ' + string);
			ssocket.send(string);
		}

		function createPin(){
			return '2345';
		}
		
	</script>
</body>
</html>